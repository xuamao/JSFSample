/*****************************************
 * 
 * Project: Cube Application Heine
 * Package Type: JSF Online Module: Page bean
 * Create by: amao.xu@altran.com
 * Date: 10.06.2013
 *
 *****************************************/
package de.heine.cube.online.pagebean;

import java.io.IOException;
import java.util.Date;
import java.util.List;

import javax.faces.application.FacesMessage;
import javax.faces.bean.ManagedBean;
import javax.faces.bean.SessionScoped;
import javax.faces.context.FacesContext;
import javax.faces.event.ActionEvent;
import javax.faces.event.ValueChangeEvent;

import org.apache.log4j.Logger;
import org.primefaces.context.RequestContext;
import org.primefaces.event.SelectEvent;

import de.heine.cube.common.Gender;
import de.heine.cube.common.api.PatientService;
import de.heine.cube.common.dto.PatientVO;
import de.heine.cube.common.exception.ServiceException;
import de.heine.cube.common.exception.SystemException;
import de.heine.cube.online.component.AbstractViewScopeBean;
import de.heine.cube.online.component.dataModel.HomePageDateModel;
import de.heine.cube.online.component.dataModel.PatientListDataModel;

/**
 * HomeOverviewBean
 * 
 * @author axu
 * 
 */
@ManagedBean
@SessionScoped
public class HomeOverviewBean extends AbstractViewScopeBean<PatientService> {

	/**
	 * 
	 */
	private static final long serialVersionUID = -6855707619823214759L;
	
	private static final Logger log = Logger.getLogger(HomeOverviewBean.class
			.getName());

	private HomePageDateModel dataModel = new HomePageDateModel();
	
	/**
	 * 
	 * Constructor
	 * 1.) init Service
	 * 2.) load Patientlist using service
	 * 3.) set DataModel
	 */
	public HomeOverviewBean() {
		super(PatientService.class);
		log.debug("load Patient list");
		try {
			List<PatientVO> patientDateModel = service.getPatients();
			dataModel.setPatientListCache(patientDateModel);
			dataModel.setPatientDataModel(new PatientListDataModel(patientDateModel));
		} catch (ServiceException e2) {
			e2.printStackTrace();
		} catch ( SystemException e){
			e.printStackTrace();
		}
	}
	
	/**
	 * 
	 * @return
	 */
	public String getMockImage(){
		if(sessionBean.getCurrentPatient()==null){
			return null;
		}else{
			return "something";
		}
	}
	
	public PatientVO getCurrentPatient(){
		PatientVO p=sessionBean.getCurrentPatient();
		if(p==null){
			p=new PatientVO();
			p.setFirstName("Firstname");
			p.setLastName("Lastname");
			p.setGender("Male");
			p.setDate_Of_Birth(new Date());
		}
		return p;
	}
	
	/**
	 * @return the dataModel
	 */
	public HomePageDateModel getDataModel() {
		return dataModel;
	}

	/**
	 * @param dataModel the dataModel to set
	 */
	public void setDataModel(HomePageDateModel dataModel) {
		this.dataModel = dataModel;
	}

	/**
	 * 
	 * If the search key word is changed, patientlist should be reloaded.
	 * 
	 * @param e
	 *            Event
	 */
	public void reloadPatient(ValueChangeEvent e) {
		log.info("Reload Patient");
		log.info("New Value" + e.getNewValue());
	}

	/**
	 * 1.) chosen a patient for currect work flow
	 * 2.) set the patient in session
	 * 
	 * @param event
	 * @throws IOException
	 */
	public void onRowSelect(SelectEvent event) throws IOException {
		PatientVO selectedPatient = (PatientVO)event.getObject();
		
		
		sessionBean.setCurrentPatient(selectedPatient);
		FacesMessage msg = new FacesMessage("Car Selected", event.getObject()
				.toString());
		
		log.info("Selected Patient Info: "+selectedPatient.toString());
		FacesContext.getCurrentInstance().addMessage(null, msg);
		FacesContext.getCurrentInstance().getExternalContext().redirect("HomeOverview.xhtml");
	}
	
	/**
	 * 1.)save the patient in server
	 * 2.)set the patient in sessionBean
	 * 
	 * @param actionEvent
	 */
	public void saveandstart(ActionEvent actionEvent){
		log.info("Action: Save and Start");
		RequestContext context = RequestContext.getCurrentInstance(); 
		try {
			PatientVO patient = savePatient();
			sessionBean.setCurrentPatient(patient);
			
			context.addCallbackParam("url", "Baseline.xhtml?patientID="+patient.getID_Patient());  
		} catch (ServiceException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (SystemException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		
		String lastname=dataModel.getLastname();
		String firstname = dataModel.getFirstname();
		boolean gender = dataModel.isGender();
		Date birthday = dataModel.getBirthday();
		
		String message = "Patient: ";
		if(lastname.equals(null)&&firstname.equals(null)&&birthday.equals(null)){
			FacesMessage msg = new FacesMessage(FacesMessage.SEVERITY_INFO, "Empty value","");  
			FacesContext.getCurrentInstance().addMessage(null, msg); 
			message ="Empty Value";
		}
		 
		context.addCallbackParam("message", message);
		
	}
	
	/**
	 * 
	 * @param actionEvent 
	 */
	public void saveandnew(ActionEvent actionEvent){
		log.info("Action: Save and new");
		RequestContext context = RequestContext.getCurrentInstance();
		FacesMessage msg = new FacesMessage(FacesMessage.SEVERITY_INFO, "", "");  
		
		try {
			 savePatient();
		} catch (ServiceException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (SystemException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		
		FacesContext.getCurrentInstance().addMessage(null, msg);  
		context.addCallbackParam("url", "HomeAddPatientBean");  
		
		String lastname=dataModel.getLastname();
		String firstname = dataModel.getFirstname();
		boolean gender = dataModel.isGender();
		Date birthday = dataModel.getBirthday();
		
		String message= firstname + lastname + birthday.toLocaleString() ;
		if(gender){
			message += " Male";
		}else {
			message += " Female";
		}
		context.addCallbackParam("message", message);
		
		dataModel.setLastname(null);
		dataModel.setFirstname(null);
		dataModel.setGender(true);
		dataModel.setBirthday(null);
	}
	
	/**
	 * 
	 * @return saved PatientVO object
	 * @throws ServiceException
	 * @throws SystemException
	 * @see PatientVO
	 * 
	 */
	private PatientVO savePatient() throws ServiceException, SystemException{
		
		String lastname=dataModel.getLastname();
		String firstname = dataModel.getFirstname();
		boolean gender = dataModel.isGender();
		Date birthday = dataModel.getBirthday();
		
		return service.createPatient(lastname, firstname, birthday ,  Gender.get( gender ? 1 : 0 ).toString());
	}
	
	/**
	 * 
	 * @param actionEvent
	 */
	public void saveCurrentPatient(ActionEvent actionEvent){
		sessionBean.setCurrentPatient(getDataModel().getSelectedPatient());
		int userId = sessionBean.getLogin().getId();
		try {
			log.info("current user ID from session is "+ userId);
			service.editPatient(getDataModel().getSelectedPatient(), userId);
		} catch (ServiceException e) {
			//e.printStackTrace();
		} catch (SystemException e) {
			//e.printStackTrace();
		}
	}
	
	
}